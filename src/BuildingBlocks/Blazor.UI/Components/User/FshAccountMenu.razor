@namespace FSH.Framework.Blazor.UI.Components.User
@inherits FSH.Framework.Blazor.UI.Components.Base.FshComponentBase

<div class="fsh-account-menu">
    <MudMenu AnchorOrigin="Origin.BottomRight"
             TransformOrigin="Origin.TopRight"
             PopoverClass="fsh-account-popover"
             Dense="false">
        <ActivatorContent>
            <MudButton Class="fsh-account-trigger" Variant="Variant.Text" Color="Color.Inherit">
                <MudAvatar Size="Size.Small" Class="fsh-trigger-avatar">
                    @if (!string.IsNullOrEmpty(AvatarUrl))
                    {
                        <MudImage Src="@AvatarUrl" Alt="@UserName" />
                    }
                    else
                    {
                        @GetInitials(UserName)
                    }
                </MudAvatar>
                <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" Size="Size.Small" Class="fsh-trigger-arrow" />
            </MudButton>
        </ActivatorContent>
        <ChildContent>
            <div class="fsh-account-dropdown">
                <!-- User profile header -->
                <div class="fsh-dropdown-header">
                    <MudAvatar Size="Size.Large" Class="fsh-header-avatar">
                        @if (!string.IsNullOrEmpty(AvatarUrl))
                        {
                            <MudImage Src="@AvatarUrl" Alt="@UserName" />
                        }
                        else
                        {
                            @GetInitials(UserName)
                        }
                    </MudAvatar>
                    <div class="fsh-header-info">
                        <span class="fsh-header-name">@UserName</span>
                        <span class="fsh-header-email">@UserEmail</span>
                        @if (!string.IsNullOrEmpty(UserRole))
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" Class="fsh-header-role">@UserRole</MudChip>
                        }
                    </div>
                </div>

                <MudDivider Class="my-0" />

                <!-- Menu items -->
                <div class="fsh-dropdown-menu">
                    <MudMenuItem Icon="@Icons.Material.Outlined.Person" OnClick="@HandleProfileClick" Class="fsh-menu-item">
                        <div class="fsh-menu-item-content">
                            <span class="fsh-menu-item-text">Profile</span>
                            <span class="fsh-menu-item-desc">View and edit your profile</span>
                        </div>
                    </MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Outlined.History" OnClick="@HandleAuditingClick" Class="fsh-menu-item">
                        <div class="fsh-menu-item-content">
                            <span class="fsh-menu-item-text">Activity Log</span>
                            <span class="fsh-menu-item-desc">View your recent activity</span>
                        </div>
                    </MudMenuItem>
                </div>

                <MudDivider Class="my-0" />

                <!-- Sign out -->
                <div class="fsh-dropdown-footer">
                    <MudMenuItem Icon="@Icons.Material.Outlined.Logout" OnClick="@HandleLogoutClick" Class="fsh-menu-item fsh-menu-item-danger">
                        Sign out
                    </MudMenuItem>
                </div>
            </div>
        </ChildContent>
    </MudMenu>
</div>

@code {
    [Parameter, EditorRequired]
    public string UserName { get; set; } = "User";

    [Parameter]
    public string? UserEmail { get; set; }

    [Parameter]
    public string? UserRole { get; set; }

    [Parameter]
    public string? AvatarUrl { get; set; }

    [Parameter]
    public EventCallback OnProfileClick { get; set; }

    [Parameter]
    public EventCallback OnAuditingClick { get; set; }

    [Parameter]
    public EventCallback OnLogoutClick { get; set; }

    private static string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "U";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpperInvariant();

        return name.Length >= 2 ? name[..2].ToUpperInvariant() : name.ToUpperInvariant();
    }

    private async Task HandleProfileClick()
    {
        if (OnProfileClick.HasDelegate)
            await OnProfileClick.InvokeAsync();
        else
            Navigation.NavigateTo("/profile");
    }

    private async Task HandleAuditingClick()
    {
        if (OnAuditingClick.HasDelegate)
            await OnAuditingClick.InvokeAsync();
        else
            Navigation.NavigateTo("/audits");
    }

    private async Task HandleLogoutClick()
    {
        if (OnLogoutClick.HasDelegate)
            await OnLogoutClick.InvokeAsync();
    }
}
