@page "/tenants/settings"
@using FSH.Playground.Blazor.ApiClient
@using FSH.Framework.Blazor.UI.Components.Page
@using FSH.Framework.Shared.Constants
@using FSH.Framework.Shared.Multitenancy
@using Microsoft.AspNetCore.Components.Authorization
@inherits ComponentBase
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider

@if (!_isRootTenantAdmin)
{
    <MudAlert Severity="Severity.Warning" Class="mb-4">
        <MudText>You do not have permission to access this page. Only root tenant administrators can manage tenant settings.</MudText>
    </MudAlert>
}
else
{
    <FshPageHeader Title="Tenant Settings"
                   Description="Configure global tenant settings and policies" />

    <MudGrid GutterSize="3">
        @* Session Management Settings *@
        <MudItem xs="12" md="6">
            <MudPaper Class="fsh-card pa-4" Style="height: 100%;">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Devices" Color="Color.Primary" />
                    <MudText Typo="Typo.h6" Class="fw-600">Session Management</MudText>
                </MudStack>
                <MudDivider Class="mb-3" />
                <MudStack Spacing="3">
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                        Session management settings will be available in a future update.
                    </MudAlert>
                    <MudText Typo="Typo.body2" Class="text-muted">
                        Configure session limits, idle timeouts, and concurrent session policies for all tenants.
                    </MudText>
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">Max Sessions per User</MudText>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">Unlimited</MudChip>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">Session Idle Timeout</MudText>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">None</MudChip>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">Session Absolute Timeout</MudText>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">7 days</MudChip>
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>

        @* Security Settings *@
        <MudItem xs="12" md="6">
            <MudPaper Class="fsh-card pa-4" Style="height: 100%;">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Primary" />
                    <MudText Typo="Typo.h6" Class="fw-600">Security Policies</MudText>
                </MudStack>
                <MudDivider Class="mb-3" />
                <MudStack Spacing="3">
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                        Security policy settings will be available in a future update.
                    </MudAlert>
                    <MudText Typo="Typo.body2" Class="text-muted">
                        Configure password policies, lockout settings, and authentication requirements.
                    </MudText>
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">Password History</MudText>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Success">Enabled (5)</MudChip>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">Account Lockout</MudText>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">Default</MudChip>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">Two-Factor Authentication</MudText>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">Optional</MudChip>
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>

        @* Quota Settings *@
        <MudItem xs="12" md="6">
            <MudPaper Class="fsh-card pa-4" Style="height: 100%;">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.DataUsage" Color="Color.Primary" />
                    <MudText Typo="Typo.h6" Class="fw-600">Usage Quotas</MudText>
                </MudStack>
                <MudDivider Class="mb-3" />
                <MudStack Spacing="3">
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                        Quota settings will be available in a future update.
                    </MudAlert>
                    <MudText Typo="Typo.body2" Class="text-muted">
                        Configure storage limits, API rate limits, and resource quotas per tenant.
                    </MudText>
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">Max Users</MudText>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">Unlimited</MudChip>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">Storage Limit</MudText>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">Unlimited</MudChip>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">API Rate Limit</MudText>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">None</MudChip>
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>

        @* Notification Settings *@
        <MudItem xs="12" md="6">
            <MudPaper Class="fsh-card pa-4" Style="height: 100%;">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Notifications" Color="Color.Primary" />
                    <MudText Typo="Typo.h6" Class="fw-600">Notifications</MudText>
                </MudStack>
                <MudDivider Class="mb-3" />
                <MudStack Spacing="3">
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                        Notification settings will be available in a future update.
                    </MudAlert>
                    <MudText Typo="Typo.body2" Class="text-muted">
                        Configure email notifications, alerts, and system messages for tenants.
                    </MudText>
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">Email Notifications</MudText>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Success">Enabled</MudChip>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">System Alerts</MudText>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Success">Enabled</MudChip>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.body2">Subscription Reminders</MudText>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Success">Enabled</MudChip>
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private bool _isRootTenantAdmin;

    protected override async Task OnInitializedAsync()
    {
        await CheckRootTenantAdmin();
    }

    private async Task CheckRootTenantAdmin()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated != true)
            {
                _isRootTenantAdmin = false;
                return;
            }

            var tenant = user.FindFirst(CustomClaims.Tenant)?.Value;
            var isRootTenant = string.Equals(tenant, MultitenancyConstants.Root.Id, StringComparison.OrdinalIgnoreCase);

            var roles = user.FindAll(System.Security.Claims.ClaimTypes.Role).Select(c => c.Value).ToList();
            var isAdmin = roles.Any(r => string.Equals(r, RoleConstants.Admin, StringComparison.OrdinalIgnoreCase));

            _isRootTenantAdmin = isRootTenant && isAdmin;
        }
        catch
        {
            _isRootTenantAdmin = false;
        }
    }
}
