@page "/tenants"
@using FSH.Playground.Blazor.ApiClient
@using FSH.Framework.Blazor.UI.Components.Dialogs
@using FSH.Framework.Blazor.UI.Components.Cards
@using FSH.Framework.Shared.Constants
@using FSH.Framework.Shared.Multitenancy
@using Microsoft.AspNetCore.Components.Authorization
@inherits ComponentBase
@inject IV1Client V1Client
@inject ITenantsClient TenantsClient
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider

@if (!_isRootTenantAdmin)
{
    <MudAlert Severity="Severity.Warning" Class="mb-4">
        <MudText>You do not have permission to access this page. Only root tenant administrators can manage tenants.</MudText>
    </MudAlert>
}
else
{
    <FshPageHeader Title="Tenants"
                   Description="Manage organization tenants and subscriptions">
        <ActionContent>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="ShowCreate">
                New Tenant
            </MudButton>
        </ActionContent>
    </FshPageHeader>

    @* Stats Cards *@
    <MudGrid Class="mb-4">
        <MudItem xs="6" sm="3">
            <FshStatCard Icon="@Icons.Material.Filled.Business"
                         IconColor="Color.Primary"
                         Value="@_stats.Total.ToString()"
                         Label="Total Tenants"
                         Badge="Total" />
        </MudItem>
        <MudItem xs="6" sm="3">
            <FshStatCard Icon="@Icons.Material.Filled.CheckCircle"
                         IconColor="Color.Success"
                         Value="@_stats.Active.ToString()"
                         Label="Active Tenants"
                         Badge="Active" />
        </MudItem>
        <MudItem xs="6" sm="3">
            <FshStatCard Icon="@Icons.Material.Filled.Cancel"
                         IconColor="Color.Error"
                         Value="@_stats.Inactive.ToString()"
                         Label="Inactive Tenants"
                         Badge="Inactive" />
        </MudItem>
        <MudItem xs="6" sm="3">
            <FshStatCard Icon="@Icons.Material.Filled.Warning"
                         IconColor="Color.Warning"
                         Value="@_stats.ExpiringSoon.ToString()"
                         Label="Expiring in 30 days"
                         Badge="Expiring" />
        </MudItem>
    </MudGrid>

    @* Filter Panel *@
    <MudExpansionPanels Class="mb-4" Elevation="0">
        <MudExpansionPanel Text="Filters" IsInitiallyExpanded="true" Class="fsh-card">
            <MudGrid GutterSize="2">
                <MudItem xs="12" sm="4">
                    <MudTextField @bind-Value="_filter.Search"
                                  Label="Search"
                                  Placeholder="Name, ID, or admin email"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true"
                                  DebounceInterval="400"
                                  OnDebounceIntervalElapsed="@((string _) => RefreshData())" />
                </MudItem>
                <MudItem xs="6" sm="2">
                    <MudSelect T="bool?" Value="_filter.IsActive" Label="Status" Clearable="true" ValueChanged="OnStatusFilterChanged">
                        <MudSelectItem T="bool?" Value="@((bool?)null)">All</MudSelectItem>
                        <MudSelectItem T="bool?" Value="true">Active</MudSelectItem>
                        <MudSelectItem T="bool?" Value="false">Inactive</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6" Class="d-flex align-center justify-end">
                    <MudButton StartIcon="@Icons.Material.Filled.FilterAltOff"
                               Color="Color.Default"
                               Variant="Variant.Text"
                               OnClick="ClearFilters">
                        Clear Filters
                    </MudButton>
                    <MudButton StartIcon="@Icons.Material.Filled.Refresh"
                               Color="Color.Primary"
                               Variant="Variant.Filled"
                               OnClick="LoadData"
                               Class="ml-2">
                        Refresh
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudExpansionPanel>
    </MudExpansionPanels>

    @* Data Grid *@
    <MudPaper Class="fsh-card pa-0" Style="overflow: hidden;">
        <MudDataGrid T="TenantDto"
                     @ref="_dataGrid"
                     Items="_filtered"
                     Loading="_loading"
                     Hover="true"
                     Dense="true"
                     Striped="true"
                     SortMode="SortMode.Single"
                     Filterable="false"
                     RowsPerPage="@_pageSize"
                     Class="tenants-datagrid">
            <Columns>
                <TemplateColumn Title="Tenant" Sortable="true" SortBy="@(x => x.Name)">
                    <CellTemplate>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudAvatar Size="Size.Small" Class="tenant-avatar">
                                @GetInitials(context.Item)
                            </MudAvatar>
                            <MudStack Spacing="0">
                                <MudLink Typo="Typo.body2" Class="fw-600" OnClick="@(() => GoToDetail(context.Item.Id))">
                                    @context.Item.Name
                                </MudLink>
                                <MudText Typo="Typo.caption" Class="text-muted">@context.Item.Id</MudText>
                            </MudStack>
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.AdminEmail" Title="Admin Email" Sortable="true" />
                <TemplateColumn Title="Subscription" Sortable="true" SortBy="@(x => x.ValidUpto)">
                    <CellTemplate>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2">@context.Item.ValidUpto.ToString("MMM dd, yyyy")</MudText>
                            @if (IsExpiringSoon(context.Item.ValidUpto))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Warning">
                                    @GetExpiryText(context.Item.ValidUpto)
                                </MudText>
                            }
                            else if (IsExpired(context.Item.ValidUpto))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Error">Expired</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Class="text-muted">
                                    @GetExpiryText(context.Item.ValidUpto)
                                </MudText>
                            }
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Database" Sortable="false">
                    <CellTemplate>
                        @if (!string.IsNullOrWhiteSpace(context.Item.ConnectionString))
                        {
                            <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Outlined">
                                <MudIcon Icon="@Icons.Material.Filled.Storage" Size="Size.Small" Class="mr-1" />
                                Dedicated
                            </MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Color="Color.Default" Size="Size.Small" Variant="Variant.Outlined">
                                <MudIcon Icon="@Icons.Material.Filled.Cloud" Size="Size.Small" Class="mr-1" />
                                Shared
                            </MudChip>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Status" Sortable="true" SortBy="@(x => x.IsActive)">
                    <CellTemplate>
                        @if (context.Item.IsActive)
                        {
                            <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Filled">Active</MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Color="Color.Error" Size="Size.Small" Variant="Variant.Filled">Inactive</MudChip>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Actions" Sortable="false" HeaderClass="text-right" CellClass="text-right">
                    <CellTemplate>
                        <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="0">
                            <MudTooltip Text="View Details">
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                               Size="Size.Small"
                                               Color="Color.Primary"
                                               OnClick="@(() => GoToDetail(context.Item.Id))" />
                            </MudTooltip>
                            <MudTooltip Text="Upgrade Subscription">
                                <MudIconButton Icon="@Icons.Material.Filled.Upgrade"
                                               Size="Size.Small"
                                               Color="Color.Info"
                                               OnClick="@(() => ShowUpgrade(context.Item))" />
                            </MudTooltip>
                            <MudTooltip Text="@GetToggleTooltip(context.Item)">
                                <MudIconButton Icon="@(context.Item.IsActive ? Icons.Material.Filled.Block : Icons.Material.Filled.CheckCircle)"
                                               Size="Size.Small"
                                               Color="@(context.Item.IsActive ? Color.Warning : Color.Success)"
                                               OnClick="@(() => ToggleStatus(context.Item))"
                                               Disabled="@IsToggleDisabled(context.Item)" />
                            </MudTooltip>
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="TenantDto" PageSizeOptions="@_pageSizeOptions" />
            </PagerContent>
            <NoRecordsContent>
                <MudStack AlignItems="AlignItems.Center" Spacing="4" Class="pa-8">
                    <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Large" Color="Color.Default" />
                    <MudText Typo="Typo.h6">No tenants found</MudText>
                    <MudText Typo="Typo.body2" Class="text-muted">Try adjusting your filters or create a new tenant.</MudText>
                </MudStack>
            </NoRecordsContent>
        </MudDataGrid>
    </MudPaper>
}

<style>
    .tenant-avatar {
        width: 32px;
        height: 32px;
        font-size: 12px;
        font-weight: 600;
        background: linear-gradient(135deg, var(--mud-palette-primary), var(--mud-palette-secondary));
        color: white;
    }

    .tenants-datagrid .mud-table-head .mud-table-row .mud-table-cell {
        font-weight: 600;
        background-color: rgba(var(--mud-palette-primary-rgb), 0.04);
    }

    .tenants-datagrid .mud-table-row:hover {
        background-color: rgba(var(--mud-palette-primary-rgb), 0.02);
    }
</style>

@code {
    private MudDataGrid<TenantDto>? _dataGrid;
    private List<TenantDto> _tenants = new();
    private List<TenantDto> _filtered = new();
    private bool _loading = true;
    private string? _busyTenantId;
    private bool _isRootTenantAdmin;

    private readonly int _pageSize = 10;
    private readonly int[] _pageSizeOptions = { 5, 10, 25, 50 };

    private TenantStats _stats = new();
    private FilterModel _filter = new();

    private class TenantStats
    {
        public int Total { get; set; }
        public int Active { get; set; }
        public int Inactive { get; set; }
        public int ExpiringSoon { get; set; }
    }

    private class FilterModel
    {
        public string? Search { get; set; }
        public bool? IsActive { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await CheckRootTenantAdmin();
        if (_isRootTenantAdmin)
        {
            await LoadData();
        }
    }

    private async Task CheckRootTenantAdmin()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            var tenant = user.FindFirst(CustomClaims.Tenant)?.Value;
            var isRootTenant = string.Equals(tenant, MultitenancyConstants.Root.Id, StringComparison.OrdinalIgnoreCase);

            var roles = user.FindAll(System.Security.Claims.ClaimTypes.Role).Select(c => c.Value).ToList();
            var isAdmin = roles.Any(r => string.Equals(r, RoleConstants.Admin, StringComparison.OrdinalIgnoreCase));

            _isRootTenantAdmin = isRootTenant && isAdmin;
        }
        catch
        {
            _isRootTenantAdmin = false;
        }
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            var result = await V1Client.TenantsGetAsync(pageSize: 100);
            _tenants = result?.Items?.ToList() ?? new List<TenantDto>();
            CalculateStats();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load tenants: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void CalculateStats()
    {
        var now = DateTimeOffset.UtcNow;
        var thirtyDaysFromNow = now.AddDays(30);

        _stats = new TenantStats
        {
            Total = _tenants.Count,
            Active = _tenants.Count(t => t.IsActive),
            Inactive = _tenants.Count(t => !t.IsActive),
            ExpiringSoon = _tenants.Count(t => t.IsActive && t.ValidUpto > now && t.ValidUpto <= thirtyDaysFromNow)
        };
    }

    private void ApplyFilters()
    {
        var query = _tenants.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(_filter.Search))
        {
            var term = _filter.Search.ToLowerInvariant();
            query = query.Where(t =>
                (t.Name?.ToLowerInvariant().Contains(term) ?? false) ||
                (t.Id?.ToLowerInvariant().Contains(term) ?? false) ||
                (t.AdminEmail?.ToLowerInvariant().Contains(term) ?? false));
        }

        if (_filter.IsActive.HasValue)
        {
            query = query.Where(t => t.IsActive == _filter.IsActive.Value);
        }

        _filtered = query.OrderBy(t => t.Name).ToList();
    }

    private void RefreshData()
    {
        ApplyFilters();
        StateHasChanged();
    }

    private async Task OnStatusFilterChanged(bool? value)
    {
        _filter.IsActive = value;
        RefreshData();
        await Task.CompletedTask;
    }

    private void ClearFilters()
    {
        _filter = new FilterModel();
        ApplyFilters();
    }

    private static string GetInitials(TenantDto tenant)
    {
        if (string.IsNullOrWhiteSpace(tenant.Name)) return "?";
        var words = tenant.Name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (words.Length >= 2)
            return $"{words[0][0]}{words[1][0]}".ToUpperInvariant();
        return tenant.Name.Length >= 2
            ? tenant.Name[..2].ToUpperInvariant()
            : tenant.Name.ToUpperInvariant();
    }

    private static bool IsRootTenant(TenantDto tenant) =>
        string.Equals(tenant.Id, MultitenancyConstants.Root.Id, StringComparison.OrdinalIgnoreCase);

    private static bool IsExpired(DateTimeOffset validUpto) =>
        validUpto <= DateTimeOffset.UtcNow;

    private static bool IsExpiringSoon(DateTimeOffset validUpto)
    {
        var now = DateTimeOffset.UtcNow;
        return validUpto > now && validUpto <= now.AddDays(30);
    }

    private static string GetExpiryText(DateTimeOffset validUpto)
    {
        var now = DateTimeOffset.UtcNow;
        if (validUpto <= now)
            return "Expired";

        var diff = validUpto - now;
        if (diff.TotalDays < 1)
            return "Expires today";
        if (diff.TotalDays < 2)
            return "Expires tomorrow";
        if (diff.TotalDays <= 30)
            return $"Expires in {(int)diff.TotalDays} days";

        return $"{(int)diff.TotalDays} days remaining";
    }

    private bool IsToggleDisabled(TenantDto tenant) =>
        string.IsNullOrWhiteSpace(tenant.Id) ||
        _busyTenantId == tenant.Id ||
        IsRootTenant(tenant);

    private static string GetToggleTooltip(TenantDto tenant)
    {
        if (IsRootTenant(tenant))
            return "Root tenant cannot be deactivated";
        return tenant.IsActive ? "Deactivate tenant" : "Activate tenant";
    }

    private void GoToDetail(string? id)
    {
        if (!string.IsNullOrWhiteSpace(id))
            Navigation.NavigateTo($"/tenants/{id}");
    }

    private async Task ToggleStatus(TenantDto tenant)
    {
        if (string.IsNullOrWhiteSpace(tenant.Id)) return;

        if (IsRootTenant(tenant))
        {
            Snackbar.Add("Root tenant cannot be deactivated.", Severity.Warning);
            return;
        }

        var action = tenant.IsActive ? "deactivate" : "activate";
        var confirmed = await DialogService.ShowConfirmAsync(
            $"{(tenant.IsActive ? "Deactivate" : "Activate")} Tenant",
            $"Are you sure you want to {action} '{tenant.Name}'?",
            tenant.IsActive ? "Deactivate" : "Activate",
            "Cancel",
            tenant.IsActive ? Color.Warning : Color.Success);

        if (!confirmed) return;

        _busyTenantId = tenant.Id;
        try
        {
            var command = new ChangeTenantActivationCommand
            {
                TenantId = tenant.Id,
                IsActive = !tenant.IsActive
            };
            await TenantsClient.ActivationAsync(tenant.Id, command);
            Snackbar.Add($"Tenant {(tenant.IsActive ? "deactivated" : "activated")} successfully.", Severity.Success);
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to update tenant: {ex.Message}", Severity.Error);
        }
        finally
        {
            _busyTenantId = null;
        }
    }

    private async Task ShowCreate()
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<CreateTenantDialog>("Create Tenant", options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadData();
        }
    }

    private async Task ShowUpgrade(TenantDto tenant)
    {
        var parameters = new DialogParameters<UpgradeTenantDialog>
        {
            { x => x.Tenant, tenant }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<UpgradeTenantDialog>("Upgrade Subscription", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadData();
        }
    }
}
