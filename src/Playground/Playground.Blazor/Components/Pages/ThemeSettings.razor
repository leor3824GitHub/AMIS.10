@page "/settings/theme"
@using FSH.Framework.Blazor.UI.Theme
@using FSH.Framework.Blazor.UI.Components.Theme
@using FSH.Framework.Blazor.UI.Components.Page
@using FSH.Playground.Blazor.Services
@inject ITenantThemeState ThemeState
@inject ISnackbar Snackbar

<PageTitle>Theme Settings</PageTitle>

<FshPageHeader Title="Theme Settings"
               Description="Customize your application's appearance and branding">
    <ActionContent>
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Default"
                   StartIcon="@Icons.Material.Outlined.Refresh"
                   OnClick="@ResetToDefaults"
                   Disabled="@(_customizer?.IsSaving ?? false)">
            Reset to Defaults
        </MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Outlined.Save"
                   OnClick="@SaveChanges"
                   Disabled="@(_customizer?.IsSaving ?? false)">
            @if (_customizer?.IsSaving ?? false)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Saving...</span>
            }
            else
            {
                <span>Save Changes</span>
            }
        </MudButton>
    </ActionContent>
</FshPageHeader>

<FshThemeCustomizer @ref="_customizer"
                    ThemeState="@ThemeState"
                    OnThemeSaved="@OnThemeSaved"
                    OnAssetUpload="@HandleAssetUpload" />

@code {
    private FshThemeCustomizer? _customizer;

    private async Task SaveChanges()
    {
        if (_customizer != null)
        {
            await _customizer.SaveChangesAsync();
        }
    }

    private async Task ResetToDefaults()
    {
        if (_customizer != null)
        {
            await _customizer.ResetToDefaultsAsync();
        }
    }

    private async Task OnThemeSaved()
    {
        // Reload theme after save to get the actual uploaded URLs
        await ThemeState.LoadThemeAsync();
        Snackbar.Add("Theme saved successfully.", Severity.Success);
    }

    private async Task HandleAssetUpload((IBrowserFile File, string AssetType, Action<string, FileUpload?> SetAsset) args)
    {
        try
        {
            // Validate file
            if (args.File.Size > 2 * 1024 * 1024) // 2MB max
            {
                Snackbar.Add("File too large. Maximum 2MB allowed.", Severity.Error);
                return;
            }

            if (!args.File.ContentType.StartsWith("image/", StringComparison.OrdinalIgnoreCase))
            {
                Snackbar.Add("Only image files are allowed.", Severity.Error);
                return;
            }

            // Read file data
            using var stream = args.File.OpenReadStream(2 * 1024 * 1024);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var bytes = memoryStream.ToArray();

            // Create file upload (same pattern as profile picture)
            var fileUpload = new FileUpload
            {
                FileName = args.File.Name,
                ContentType = args.File.ContentType,
                Data = bytes
            };

            // Set preview URL as data URL for immediate visual feedback
            var previewUrl = $"data:{args.File.ContentType};base64,{Convert.ToBase64String(bytes)}";

            // Set both preview URL and file upload data via callback
            args.SetAsset(previewUrl, fileUpload);
            Snackbar.Add("Image ready. Click Save to upload.", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to process file: {ex.Message}", Severity.Error);
        }
    }
}
