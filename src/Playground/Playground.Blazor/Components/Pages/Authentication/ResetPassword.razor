@page "/reset-password"
@layout EmptyLayout
@attribute [AllowAnonymous]
@using FSH.Framework.Shared.Multitenancy
@using Microsoft.AspNetCore.Authorization
@using FSH.Playground.Blazor.ApiClient
@inject NavigationManager Navigation
@inject IIdentityClient IdentityClient
@inject ISnackbar Snackbar

<PageTitle>Reset Password</PageTitle>
<div class="auth-page">
    <div class="auth-wrapper">
        @* Logo/Brand *@
        <div class="brand-section">
            <div class="brand-icon">
                <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" />
            </div>
            <span class="brand-name">fullstackhero</span>
        </div>

        @* Reset Password Card *@
        <div class="auth-card">
            @if (!_passwordReset)
            {
                @if (string.IsNullOrEmpty(_token))
                {
                    @* Invalid Token State *@
                    <div class="error-state">
                        <div class="error-state-icon">
                            <MudIcon Icon="@Icons.Material.Filled.LinkOff" Size="Size.Large" />
                        </div>
                        <h1 class="auth-title">Invalid reset link</h1>
                        <p class="auth-subtitle">This password reset link is invalid or has expired. Please request a new one.</p>

                        <a href="/forgot-password" class="auth-button-link">
                            Request new link
                        </a>
                    </div>
                }
                else
                {
                    @* Header *@
                    <div class="auth-header">
                        <div class="header-icon">
                            <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" />
                        </div>
                        <h1 class="auth-title">Set new password</h1>
                        <p class="auth-subtitle">Your new password must be different from previously used passwords.</p>
                    </div>

                    @* Form *@
                    <EditForm Model="@_model" OnValidSubmit="HandleSubmitAsync" class="auth-form">
                        <DataAnnotationsValidator />

                        @* Tenant Field *@
                        <div class="form-group">
                            <label class="form-label">Tenant</label>
                            <input type="text"
                                   @bind="_model.Tenant"
                                   placeholder="Enter tenant name"
                                   class="form-input"
                                   required />
                        </div>

                        @* Password Field *@
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="@(_showPassword ? "text" : "password")"
                                   @bind="_model.Password"
                                   placeholder="Enter new password"
                                   class="form-input"
                                   required />
                        </div>

                        @* Confirm Password Field *@
                        <div class="form-group">
                            <label class="form-label">Confirm Password</label>
                            <input type="@(_showPassword ? "text" : "password")"
                                   @bind="_model.ConfirmPassword"
                                   placeholder="Confirm new password"
                                   class="form-input"
                                   required />
                        </div>

                        @* Show Password Toggle *@
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" @bind="_showPassword" class="checkbox-input" />
                                <span>Show password</span>
                            </label>
                        </div>

                        @* Error Message *@
                        @if (!string.IsNullOrEmpty(_errorMessage))
                        {
                            <div class="error-message">
                                <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small" />
                                <span>@_errorMessage</span>
                            </div>
                        }

                        @* Submit Button *@
                        <button type="submit" class="auth-button" disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Inherit" />
                                <span>Resetting password...</span>
                            }
                            else
                            {
                                <span>Reset password</span>
                            }
                        </button>

                        @* Back to Login *@
                        <a href="/login" class="back-link">
                            <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Size="Size.Small" />
                            <span>Back to login</span>
                        </a>
                    </EditForm>
                }
            }
            else
            {
                @* Success State *@
                <div class="success-state">
                    <div class="success-icon">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" />
                    </div>
                    <h1 class="auth-title">Password reset successful</h1>
                    <p class="auth-subtitle">Your password has been successfully reset. You can now sign in with your new password.</p>

                    <a href="/login" class="auth-button-link">
                        Sign in
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery(Name = "token")]
    public string? Token { get; set; }

    [SupplyParameterFromQuery(Name = "email")]
    public string? Email { get; set; }

    private ResetPasswordModel _model = new();
    private string? _token;
    private bool _showPassword = false;
    private bool _isLoading = false;
    private bool _passwordReset = false;
    private string? _errorMessage;

    private class ResetPasswordModel
    {
        public string Tenant { get; set; } = "root";
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    protected override void OnInitialized()
    {
        _token = Token;
    }

    private async Task HandleSubmitAsync()
    {
        _errorMessage = null;

        if (_model.Password != _model.ConfirmPassword)
        {
            _errorMessage = "Passwords do not match.";
            return;
        }

        if (string.IsNullOrWhiteSpace(_model.Password))
        {
            _errorMessage = "Please enter a new password.";
            return;
        }

        if (string.IsNullOrWhiteSpace(_token) || string.IsNullOrWhiteSpace(Email))
        {
            _errorMessage = "Invalid reset link. Please request a new password reset.";
            return;
        }

        _isLoading = true;

        try
        {
            var command = new ResetPasswordCommand
            {
                Email = Email!,
                Password = _model.Password,
                Token = _token!
            };

            await IdentityClient.ResetPasswordAsync(_model.Tenant, command);

            _passwordReset = true;
            Snackbar.Add("Password reset successfully!", Severity.Success);
        }
        catch (ApiException ex)
        {
            _errorMessage = ex.Message;
        }
        catch (Exception ex)
        {
            _errorMessage = "An unexpected error occurred. Please try again.";
            Console.WriteLine(ex);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
