@page "/health"
@using FSH.Playground.Blazor.ApiClient
@using FSH.Framework.Blazor.UI.Components.Cards
@using System.Timers
@implements IDisposable
@inject IHealthClient HealthClient
@inject ISnackbar Snackbar

<FshPageHeader Title="System Health"
               Description="Real-time monitoring of system components and services">
    <ActionContent>
        <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Class="mr-2">
            Last updated: @_lastUpdated.ToString("HH:mm:ss")
        </MudChip>
        <MudToggleIconButton @bind-Toggled="_autoRefresh"
                             Icon="@Icons.Material.Outlined.PlayArrow"
                             ToggledIcon="@Icons.Material.Outlined.Pause"
                             Size="Size.Small"
                             ToggledColor="Color.Success"
                             Title="@(_autoRefresh ? "Auto-refresh ON" : "Auto-refresh OFF")" />
        <MudIconButton Icon="@Icons.Material.Outlined.Refresh"
                       Color="Color.Primary"
                       OnClick="RefreshHealth"
                       Disabled="_loading"
                       Title="Refresh now" />
    </ActionContent>
</FshPageHeader>

@* Stats Cards *@
<MudGrid Class="mb-4">
    <MudItem xs="6" sm="3">
        <FshStatCard Icon="@Icons.Material.Filled.CheckCircle"
                     IconColor="Color.Success"
                     Value="@((_readyResult?.Results?.Count(r => r.Status == "Healthy") ?? 0).ToString())"
                     Label="Healthy Services"
                     Badge="Healthy" />
    </MudItem>
    <MudItem xs="6" sm="3">
        <FshStatCard Icon="@Icons.Material.Filled.Warning"
                     IconColor="Color.Warning"
                     Value="@((_readyResult?.Results?.Count(r => r.Status == "Degraded") ?? 0).ToString())"
                     Label="Degraded Services"
                     Badge="Degraded" />
    </MudItem>
    <MudItem xs="6" sm="3">
        <FshStatCard Icon="@Icons.Material.Filled.Error"
                     IconColor="Color.Error"
                     Value="@((_readyResult?.Results?.Count(r => r.Status == "Unhealthy") ?? 0).ToString())"
                     Label="Unhealthy Services"
                     Badge="Unhealthy" />
    </MudItem>
    <MudItem xs="6" sm="3">
        <FshStatCard Icon="@Icons.Material.Filled.Speed"
                     IconColor="Color.Info"
                     Value="@($"{GetAverageDuration()}ms")"
                     Label="Avg Response Time"
                     Badge="Response" />
    </MudItem>
</MudGrid>

@* Services Grid *@
<MudText Typo="Typo.h6" Class="fw-600 mb-3">Service Status</MudText>
<MudGrid Class="mb-4">
    @if (_readyResult?.Results != null)
    {
        @foreach (var entry in _readyResult.Results.OrderBy(GetStatusSortOrder))
        {
            <MudItem xs="6" sm="3">
                <FshStatCard Icon="@GetServiceIcon(entry.Name)"
                             IconColor="@GetStatusColor(entry.Status)"
                             Value="@($"{entry.DurationMs:F1}ms")"
                             Label="@FormatServiceName(entry.Name)"
                             Badge="@entry.Status" />
            </MudItem>
        }
    }
    else if (_loading)
    {
        @for (int i = 0; i < 6; i++)
        {
            <MudItem xs="6" sm="3">
                <MudPaper Class="fsh-stat-card" Elevation="0">
                    <div class="pa-5">
                        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" />
                    </div>
                </MudPaper>
            </MudItem>
        }
    }
</MudGrid>

@* Endpoints Section *@
<MudGrid>
    <MudItem xs="12" md="6">
        <MudPaper Class="fsh-card pa-4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Outlined.Favorite" Color="Color.Success" />
                <MudText Typo="Typo.h6" Class="fw-600">Liveness Probe</MudText>
                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                         Color="@GetStatusColor(_liveResult?.Status)" Class="ml-auto">
                    @(_liveResult?.Status ?? "Unknown")
                </MudChip>
            </MudStack>
            <MudText Typo="Typo.body2" Class="text-muted mb-3">
                Basic process check - confirms the application is running.
            </MudText>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Outlined.Link">
                    /health/live
                </MudChip>
                <MudText Typo="Typo.caption" Class="text-muted">
                    @(_liveResult?.Results?.FirstOrDefault()?.DurationMs.ToString("F2") ?? "0")ms
                </MudText>
            </MudStack>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="6">
        <MudPaper Class="fsh-card pa-4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Outlined.FactCheck" Color="Color.Primary" />
                <MudText Typo="Typo.h6" Class="fw-600">Readiness Probe</MudText>
                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                         Color="@GetStatusColor(_readyResult?.Status)" Class="ml-auto">
                    @(_readyResult?.Status ?? "Unknown")
                </MudChip>
            </MudStack>
            <MudText Typo="Typo.body2" Class="text-muted mb-3">
                Full dependency check - validates all services and databases.
            </MudText>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Outlined.Link">
                    /health/ready
                </MudChip>
                <MudText Typo="Typo.caption" Class="text-muted">
                    @GetTotalDuration()ms total
                </MudText>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@* History Timeline *@
@if (_healthHistory.Any())
{
    <MudPaper Class="fsh-card pa-4 mt-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Outlined.Timeline" Color="Color.Primary" />
            <MudText Typo="Typo.h6" Class="fw-600">Recent Checks</MudText>
            <MudText Typo="Typo.caption" Class="text-muted ml-auto">Last @_healthHistory.Count checks</MudText>
        </MudStack>
        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.End" Style="height: 40px;">
            @foreach (var record in _healthHistory.TakeLast(20))
            {
                <MudTooltip Text="@($"{record.Time:HH:mm:ss} - {record.Status}")">
                    <div style="@GetTimelineBarStyle(record.Status)"></div>
                </MudTooltip>
            }
        </MudStack>
    </MudPaper>
}


@code {
    private HealthResult? _liveResult;
    private HealthResult? _readyResult;
    private bool _loading = true;
    private bool _autoRefresh = true;
    private DateTime _lastUpdated = DateTime.Now;
    private Timer? _refreshTimer;
    private List<HealthRecord> _healthHistory = new();
    private int _uptimePercent = 100;

    protected override async Task OnInitializedAsync()
    {
        await RefreshHealth();
        StartAutoRefresh();
    }

    private void StartAutoRefresh()
    {
        _refreshTimer = new Timer(10000); // 10 seconds
        _refreshTimer.Elapsed += async (sender, e) =>
        {
            if (_autoRefresh)
            {
                await InvokeAsync(async () =>
                {
                    await RefreshHealth();
                    StateHasChanged();
                });
            }
        };
        _refreshTimer.Start();
    }

    private async Task RefreshHealth()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            var liveTask = HealthClient.LiveAsync();
            var readyTask = HealthClient.ReadyAsync();

            await Task.WhenAll(liveTask, readyTask);

            _liveResult = await liveTask;
            _readyResult = await readyTask;

            _lastUpdated = DateTime.Now;

            // Add to history
            _healthHistory.Add(new HealthRecord
            {
                Time = _lastUpdated,
                Status = _readyResult?.Status ?? "Unknown"
            });

            // Keep only last 50 records
            if (_healthHistory.Count > 50)
                _healthHistory.RemoveAt(0);

            // Calculate uptime
            var healthyCount = _healthHistory.Count(h => h.Status == "Healthy");
            _uptimePercent = _healthHistory.Count > 0
                ? (int)Math.Round((double)healthyCount / _healthHistory.Count * 100)
                : 100;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to fetch health status: {ex.Message}", Severity.Error);
            _healthHistory.Add(new HealthRecord
            {
                Time = DateTime.Now,
                Status = "Unhealthy"
            });
        }
        finally
        {
            _loading = false;
        }
    }

    private static string GetStatusText(string? status) => status switch
    {
        "Healthy" => "All Systems Operational",
        "Degraded" => "Degraded Performance",
        "Unhealthy" => "System Issues Detected",
        _ => "Checking Status..."
    };

    private static string GetStatusIcon(string? status) => status switch
    {
        "Healthy" => Icons.Material.Filled.CheckCircle,
        "Degraded" => Icons.Material.Filled.Warning,
        "Unhealthy" => Icons.Material.Filled.Error,
        _ => Icons.Material.Filled.HelpOutline
    };

    private static Color GetStatusColor(string? status) => status switch
    {
        "Healthy" => Color.Success,
        "Degraded" => Color.Warning,
        "Unhealthy" => Color.Error,
        _ => Color.Default
    };

    private static int GetStatusSortOrder(HealthEntry entry)
    {
        // Show unhealthy first (0), then degraded (1), then healthy (2)
        return entry.Status switch
        {
            "Healthy" => 2,
            "Degraded" => 1,
            _ => 0
        };
    }

    private static string GetServiceIcon(string? name) => name?.ToLower() switch
    {
        var n when n?.Contains("identity") == true => Icons.Material.Outlined.Person,
        var n when n?.Contains("audit") == true => Icons.Material.Outlined.History,
        var n when n?.Contains("tenant") == true => Icons.Material.Outlined.Business,
        var n when n?.Contains("migration") == true => Icons.Material.Outlined.Storage,
        var n when n?.Contains("db") == true => Icons.Material.Outlined.Storage,
        "self" => Icons.Material.Outlined.Memory,
        _ => Icons.Material.Outlined.Dns
    };

    private static string FormatServiceName(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "Unknown";

        return name switch
        {
            "self" => "Application Core",
            "db:identity" => "Identity Database",
            "db:auditing" => "Audit Database",
            "db:multitenancy" => "Multitenancy Database",
            "db:tenants-migrations" => "Tenant Migrations",
            _ => name.Replace(":", " - ").Replace("-", " ")
                     .Split(' ')
                     .Select(w => char.ToUpper(w[0]) + w[1..].ToLower())
                     .Aggregate((a, b) => $"{a} {b}")
        };
    }

    private string GetTotalDuration()
    {
        if (_readyResult?.Results == null) return "0";
        return _readyResult.Results.Sum(r => r.DurationMs).ToString("F0");
    }

    private string GetAverageDuration()
    {
        if (_readyResult?.Results == null || !_readyResult.Results.Any()) return "0";
        return _readyResult.Results.Average(r => r.DurationMs).ToString("F1");
    }

    private static string GetTimelineBarStyle(string status)
    {
        var color = status switch
        {
            "Healthy" => "var(--mud-palette-success)",
            "Degraded" => "var(--mud-palette-warning)",
            "Unhealthy" => "var(--mud-palette-error)",
            _ => "var(--mud-palette-gray-default)"
        };
        return $"width: 12px; height: 100%; background: {color}; border-radius: 4px 4px 0 0; cursor: pointer;";
    }

    public void Dispose()
    {
        _refreshTimer?.Stop();
        _refreshTimer?.Dispose();
    }

    private class HealthRecord
    {
        public DateTime Time { get; set; }
        public string Status { get; set; } = "";
    }
}
