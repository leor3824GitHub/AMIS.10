@page "/roles/{Id:guid}/permissions"
@using FSH.Playground.Blazor.ApiClient
@using FSH.Framework.Blazor.UI.Components.Dialogs
@inherits ComponentBase
@inject IIdentityClient IdentityClient
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<FshPageHeader Title="Manage Role Permissions"
               Description="Configure what actions this role can perform">
    <ActionContent>
        <MudButton Variant="Variant.Text"
                   Color="Color.Default"
                   StartIcon="@Icons.Material.Filled.ArrowBack"
                   OnClick="GoBack">
            Back to Roles
        </MudButton>
    </ActionContent>
</FshPageHeader>

@if (_loading)
{
    <MudPaper Class="fsh-card pa-8">
        <MudStack AlignItems="AlignItems.Center" Spacing="4">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            <MudText Typo="Typo.body1">Loading role information...</MudText>
        </MudStack>
    </MudPaper>
}
else if (_role is null)
{
    <MudPaper Class="fsh-card pa-8">
        <MudStack AlignItems="AlignItems.Center" Spacing="4">
            <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Size="Size.Large" Color="Color.Error" />
            <MudText Typo="Typo.h6">Role Not Found</MudText>
            <MudText Typo="Typo.body2" Class="text-muted">The requested role could not be found.</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GoBack">
                Back to Roles
            </MudButton>
        </MudStack>
    </MudPaper>
}
else
{
    @* Role Info Header *@
    <MudPaper Class="fsh-card pa-4 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Spacing="0">
                <MudText Typo="Typo.h5" Class="fw-700">@_role.Name</MudText>
                <MudText Typo="Typo.body2" Class="text-muted">
                    @(string.IsNullOrEmpty(_role.Description) ? "No description provided" : _role.Description)
                </MudText>
                <MudStack Row="true" Spacing="1" Class="mt-2">
                    @if (IsAdminRole(_role.Name))
                    {
                        <MudChip T="string" Color="Color.Error" Size="Size.Small" Variant="Variant.Outlined">
                            <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Small" Class="mr-1" />
                            Admin (Full Access)
                        </MudChip>
                    }
                    else if (IsSystemRole(_role.Name))
                    {
                        <MudChip T="string" Color="Color.Warning" Size="Size.Small" Variant="Variant.Outlined">
                            <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Small" Class="mr-1" />
                            System Role
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Outlined">
                            <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Class="mr-1" />
                            Custom Role
                        </MudChip>
                    }
                    <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Filled">
                        @_currentPermissions.Count permissions
                    </MudChip>
                </MudStack>
            </MudStack>
            @if (!IsAdminRole(_role.Name))
            {
                <MudStack Row="true" Spacing="2">
                    @if (HasChanges)
                    {
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Default"
                                   OnClick="ResetChanges"
                                   Disabled="_saving">
                            Reset
                        </MudButton>
                    }
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="SavePermissions"
                               Disabled="@(!HasChanges || _saving)">
                        @if (_saving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        }
                        Save Changes
                    </MudButton>
                </MudStack>
            }
        </MudStack>
    </MudPaper>

    @if (IsAdminRole(_role.Name))
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mb-4">
            <MudText Typo="Typo.body2">
                <strong>Admin role has full access to all permissions.</strong> These permissions cannot be modified.
            </MudText>
        </MudAlert>
    }

    @* Quick Stats *@
    <MudGrid Class="mb-4">
        <MudItem xs="6" sm="3">
            <MudCard Class="stats-card-sm" Elevation="1">
                <MudCardContent Class="pa-3">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h6" Class="fw-700">@_currentPermissions.Count</MudText>
                            <MudText Typo="Typo.caption" Class="text-muted">Assigned</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudCard Class="stats-card-sm" Elevation="1">
                <MudCardContent Class="pa-3">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.RadioButtonUnchecked" Color="Color.Default" />
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h6" Class="fw-700">@(_allPermissions.Count - _currentPermissions.Count)</MudText>
                            <MudText Typo="Typo.caption" Class="text-muted">Available</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudCard Class="stats-card-sm" Elevation="1">
                <MudCardContent Class="pa-3">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Category" Color="Color.Info" />
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h6" Class="fw-700">@_groupedPermissions.Count</MudText>
                            <MudText Typo="Typo.caption" Class="text-muted">Categories</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudCard Class="stats-card-sm" Elevation="1">
                <MudCardContent Class="pa-3">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@(HasChanges ? Icons.Material.Filled.Pending : Icons.Material.Filled.CheckCircleOutline)"
                                 Color="@(HasChanges ? Color.Warning : Color.Success)" />
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h6" Class="fw-700">@GetChangedCount()</MudText>
                            <MudText Typo="Typo.caption" Class="text-muted">Changes</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    @* Search and Bulk Actions *@
    <MudPaper Class="fsh-card pa-4 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudTextField @bind-Value="_searchTerm"
                          Placeholder="Search permissions..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          Style="max-width: 300px;"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense" />
            <MudStack Row="true" Spacing="2">
                @if (!_isReadOnly)
                {
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Success"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.SelectAll"
                               OnClick="SelectAll">
                        Select All
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Warning"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.Deselect"
                               OnClick="DeselectAll">
                        Deselect All
                    </MudButton>
                }
                <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                    <MudButton OnClick="ExpandAll" StartIcon="@Icons.Material.Filled.UnfoldMore">
                        Expand
                    </MudButton>
                    <MudButton OnClick="CollapseAll" StartIcon="@Icons.Material.Filled.UnfoldLess">
                        Collapse
                    </MudButton>
                </MudButtonGroup>
            </MudStack>
        </MudStack>
    </MudPaper>

    @* Permissions by Category *@
    <MudExpansionPanels MultiExpansion="true" Class="permissions-panels">
        @foreach (var group in FilteredGroups)
        {
            var categoryKey = group.Key;
            var groupPermissions = group.ToList();
            var totalCount = groupPermissions.Count;

            <MudExpansionPanel @key="categoryKey"
                               IsExpanded="@_expandedCategories.Contains(categoryKey)"
                               IsExpandedChanged="@((bool expanded) => OnCategoryExpandedChanged(categoryKey, expanded))"
                               Class="fsh-card mb-3 permission-category">
                <TitleContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <MudCheckBox T="bool"
                                         Value="@IsCategoryAllSelected(categoryKey)"
                                         Indeterminate="@IsCategorySomeSelected(categoryKey)"
                                         ValueChanged="@((bool val) => ToggleCategory(categoryKey, val))"
                                         Color="Color.Primary"
                                         Disabled="@_isReadOnly"
                                         Class="category-checkbox" />
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.subtitle1" Class="fw-600">@FormatCategoryName(categoryKey)</MudText>
                                <MudText Typo="Typo.caption" Class="text-muted">@totalCount permissions available</MudText>
                            </MudStack>
                        </MudStack>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudChip T="string"
                                     Size="Size.Small"
                                     Color="@GetCategoryChipColor(categoryKey)"
                                     Variant="@(GetCategoryAssignedCount(categoryKey) > 0 ? Variant.Filled : Variant.Outlined)">
                                @GetCategoryAssignedCount(categoryKey) / @totalCount
                            </MudChip>
                        </MudStack>
                    </MudStack>
                </TitleContent>
                <ChildContent>
                    <MudDivider Class="mb-3" />
                    <MudGrid Spacing="2">
                        @foreach (var permission in groupPermissions.OrderBy(p => p))
                        {
                            // Capture loop variable to avoid closure issue
                            var perm = permission;
                            var permissionName = GetPermissionDisplayName(perm);

                            <MudItem xs="12" sm="6" md="4">
                                <MudPaper Class="@GetPermissionItemClass(perm)" Elevation="0">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudCheckBox T="bool"
                                                     Value="@IsPermissionAssigned(perm)"
                                                     ValueChanged="@((bool val) => TogglePermission(perm, val))"
                                                     Color="@(IsPermissionAssigned(perm) ? Color.Success : Color.Default)"
                                                     Disabled="@_isReadOnly"
                                                     Size="Size.Small" />
                                        <MudStack Spacing="0" Style="flex: 1; min-width: 0;">
                                            <MudText Typo="Typo.body2" Class="fw-600" Style="word-break: break-word;">
                                                @permissionName
                                            </MudText>
                                            @if (HasPermissionChanged(perm))
                                            {
                                                <MudText Typo="Typo.caption" Color="@(IsPermissionAssigned(perm) ? Color.Success : Color.Warning)">
                                                    @(IsPermissionAssigned(perm) ? "Will be added" : "Will be removed")
                                                </MudText>
                                            }
                                        </MudStack>
                                        @if (IsPermissionAssigned(perm))
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle"
                                                     Size="Size.Small"
                                                     Color="Color.Success" />
                                        }
                                    </MudStack>
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                </ChildContent>
            </MudExpansionPanel>
        }
    </MudExpansionPanels>

    @if (!FilteredGroups.Any())
    {
        <MudPaper Class="fsh-card pa-8">
            <MudStack AlignItems="AlignItems.Center" Spacing="4">
                <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Default" />
                <MudText Typo="Typo.h6">No permissions found</MudText>
                <MudText Typo="Typo.body2" Class="text-muted">
                    @if (!string.IsNullOrEmpty(_searchTerm))
                    {
                        <span>No permissions match your search. Try a different term.</span>
                    }
                    else
                    {
                        <span>No permissions available in the system.</span>
                    }
                </MudText>
            </MudStack>
        </MudPaper>
    }
}

<style>
    .stats-card-sm {
        border-radius: 12px;
        transition: transform 0.2s ease;
    }

    .stats-card-sm:hover {
        transform: translateY(-2px);
    }

    .permissions-panels .mud-expansion-panel {
        border-radius: 12px !important;
        overflow: hidden;
    }

    .permission-category {
        border: 1px solid rgba(var(--mud-palette-primary-rgb), 0.1);
    }

    .category-checkbox {
        margin-left: -8px;
    }

    .permission-item {
        border-radius: 8px;
        border: 1px solid rgba(0,0,0,0.08);
        transition: all 0.2s ease;
        background: transparent;
    }

    .permission-item:hover {
        background-color: rgba(var(--mud-palette-primary-rgb), 0.04);
        border-color: rgba(var(--mud-palette-primary-rgb), 0.2);
    }

    .permission-assigned {
        background-color: rgba(var(--mud-palette-success-rgb), 0.05);
        border-color: rgba(var(--mud-palette-success-rgb), 0.2);
    }

    .permission-changed {
        border-left: 3px solid var(--mud-palette-warning);
        background-color: rgba(var(--mud-palette-warning-rgb), 0.05);
    }
</style>

@code {
    [Parameter] public Guid Id { get; set; }

    private bool _loading = true;
    private bool _saving;
    private string _searchTerm = "";
    private bool _isReadOnly;

    private RoleDto? _role;
    private List<string> _allPermissions = new();
    private HashSet<string> _originalPermissions = new();
    private HashSet<string> _currentPermissions = new();

    private List<IGrouping<string, string>> _groupedPermissions = new();
    private HashSet<string> _expandedCategories = new();

    private bool HasChanges => !_isReadOnly && !_originalPermissions.SetEquals(_currentPermissions);

    private IEnumerable<IGrouping<string, string>> FilteredGroups
    {
        get
        {
            if (string.IsNullOrWhiteSpace(_searchTerm))
                return _groupedPermissions;

            var term = _searchTerm.ToLowerInvariant();
            return _groupedPermissions
                .Select(g => new
                {
                    Key = g.Key,
                    Permissions = g.Where(p =>
                        p.ToLowerInvariant().Contains(term) ||
                        GetPermissionResource(p).ToLowerInvariant().Contains(term) ||
                        GetPermissionAction(p).ToLowerInvariant().Contains(term)
                    ).ToList()
                })
                .Where(g => g.Permissions.Any())
                .Select(g => g.Permissions.GroupBy(_ => g.Key).First());
        }
    }

    // Permission format: Permissions.{Resource}.{Action}
    private static string GetPermissionResource(string permission)
    {
        var parts = permission.Split('.');
        return parts.Length >= 2 ? parts[1] : "Other";
    }

    private static string GetPermissionAction(string permission)
    {
        var parts = permission.Split('.');
        return parts.Length >= 3 ? parts[2] : permission;
    }

    private static readonly HashSet<string> SystemRoles = new(StringComparer.OrdinalIgnoreCase)
    {
        "Admin", "Administrator", "Basic"
    };

    private static readonly HashSet<string> AdminRoles = new(StringComparer.OrdinalIgnoreCase)
    {
        "Admin", "Administrator"
    };

    private static bool IsSystemRole(string? roleName) =>
        !string.IsNullOrEmpty(roleName) && SystemRoles.Contains(roleName);

    private static bool IsAdminRole(string? roleName) =>
        !string.IsNullOrEmpty(roleName) && AdminRoles.Contains(roleName);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            // Load role with its current permissions
            _role = await IdentityClient.PermissionsGetAsync(Id);

            // Load all available permissions first
            var allPerms = await IdentityClient.PermissionsGetAsync();
            _allPermissions = allPerms?.ToList() ?? new List<string>();

            if (_role is not null)
            {
                _isReadOnly = IsAdminRole(_role.Name);

                if (_isReadOnly)
                {
                    // Admin role always has all permissions
                    _originalPermissions = new HashSet<string>(_allPermissions);
                    _currentPermissions = new HashSet<string>(_allPermissions);
                }
                else
                {
                    _originalPermissions = new HashSet<string>(_role.Permissions ?? new List<string>());
                    _currentPermissions = new HashSet<string>(_originalPermissions);
                }
            }

            // Group permissions by Resource (second part: Permissions.{Resource}.{Action})
            _groupedPermissions = _allPermissions
                .GroupBy(p => GetPermissionResource(p))
                .OrderBy(g => g.Key)
                .ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private bool IsPermissionAssigned(string permission) =>
        _currentPermissions.Contains(permission);

    private bool HasPermissionChanged(string permission) =>
        _currentPermissions.Contains(permission) != _originalPermissions.Contains(permission);

    private string GetPermissionItemClass(string permission)
    {
        var isAssigned = IsPermissionAssigned(permission);
        var hasChanged = HasPermissionChanged(permission);
        var classes = "permission-item pa-3";
        if (hasChanged) classes += " permission-changed";
        if (isAssigned) classes += " permission-assigned";
        return classes;
    }

    private int GetChangedCount()
    {
        var added = _currentPermissions.Except(_originalPermissions).Count();
        var removed = _originalPermissions.Except(_currentPermissions).Count();
        return added + removed;
    }

    private int GetCategoryAssignedCount(string category)
    {
        return _allPermissions
            .Where(p => GetPermissionResource(p) == category)
            .Count(p => _currentPermissions.Contains(p));
    }

    private bool IsCategoryAllSelected(string category)
    {
        var categoryPermissions = _allPermissions.Where(p => GetPermissionResource(p) == category).ToList();
        return categoryPermissions.Count > 0 && categoryPermissions.All(p => _currentPermissions.Contains(p));
    }

    private bool IsCategorySomeSelected(string category)
    {
        var categoryPermissions = _allPermissions.Where(p => GetPermissionResource(p) == category).ToList();
        var assignedCount = categoryPermissions.Count(p => _currentPermissions.Contains(p));
        return assignedCount > 0 && assignedCount < categoryPermissions.Count;
    }

    private Color GetCategoryChipColor(string category)
    {
        if (IsCategoryAllSelected(category)) return Color.Success;
        if (IsCategorySomeSelected(category)) return Color.Warning;
        return Color.Default;
    }

    private void TogglePermission(string permission, bool enabled)
    {
        if (enabled)
            _currentPermissions.Add(permission);
        else
            _currentPermissions.Remove(permission);
        StateHasChanged();
    }

    private void ToggleCategory(string category, bool enabled)
    {
        var categoryPermissions = _allPermissions
            .Where(p => GetPermissionResource(p) == category)
            .ToList();

        foreach (var permission in categoryPermissions)
        {
            if (enabled)
                _currentPermissions.Add(permission);
            else
                _currentPermissions.Remove(permission);
        }
        StateHasChanged();
    }

    private void SelectAll()
    {
        foreach (var permission in _allPermissions)
        {
            _currentPermissions.Add(permission);
        }
        StateHasChanged();
    }

    private void DeselectAll()
    {
        _currentPermissions.Clear();
        StateHasChanged();
    }

    private void ExpandAll()
    {
        foreach (var group in _groupedPermissions)
        {
            _expandedCategories.Add(group.Key);
        }
        StateHasChanged();
    }

    private void CollapseAll()
    {
        _expandedCategories.Clear();
        StateHasChanged();
    }

    private void OnCategoryExpandedChanged(string categoryKey, bool expanded)
    {
        if (expanded)
            _expandedCategories.Add(categoryKey);
        else
            _expandedCategories.Remove(categoryKey);
    }

    private void ResetChanges()
    {
        _currentPermissions = new HashSet<string>(_originalPermissions);
        StateHasChanged();
    }

    private async Task SavePermissions()
    {
        _saving = true;
        try
        {
            var command = new UpdatePermissionsCommand
            {
                RoleId = Id.ToString(),
                Permissions = _currentPermissions.ToList()
            };

            await IdentityClient.PermissionsPutAsync(Id.ToString(), command);

            _originalPermissions = new HashSet<string>(_currentPermissions);

            Snackbar.Add("Permissions updated successfully.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save permissions: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/roles");
    }

    private static string FormatCategoryName(string category)
    {
        if (string.IsNullOrEmpty(category)) return "Other";
        return char.ToUpper(category[0]) + category.Substring(1);
    }

    private static string GetPermissionDisplayName(string permission)
    {
        // Permission format: Permissions.{Resource}.{Action}
        // Show the action with nice formatting
        var action = GetPermissionAction(permission);

        // Add spaces before capital letters for readability (e.g., "UpgradeSubscription" -> "Upgrade Subscription")
        var formatted = string.Concat(action.Select((c, i) =>
            i > 0 && char.IsUpper(c) ? " " + c : c.ToString()));

        return formatted;
    }

    private static string GetCategoryDescription(string category) => category switch
    {
        "Tenants" => "Manage multi-tenant operations",
        "Users" => "Manage user accounts",
        "Roles" => "Manage security roles",
        "UserRoles" => "Assign roles to users",
        "RoleClaims" => "Manage role permissions",
        "AuditTrails" => "View audit logs",
        "Hangfire" => "Access job dashboard",
        "Dashboard" => "Access main dashboard",
        _ => $"Manage {category.ToLowerInvariant()}"
    };
}
