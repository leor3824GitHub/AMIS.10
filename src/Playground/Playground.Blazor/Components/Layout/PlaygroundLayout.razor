@inherits LayoutComponentBase
@implements IDisposable
@using FSH.Framework.Blazor.UI.Components.Button
@using FSH.Framework.Blazor.UI.Components.Layouts
@using FSH.Framework.Blazor.UI.Components.User
@using FSH.Framework.Blazor.UI.Components.Dialogs
@using FSH.Framework.Blazor.UI.Theme
@using FSH.Playground.Blazor.Components.Pages
@using Microsoft.AspNetCore.WebUtilities
@using FSH.Playground.Blazor.Services
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IHttpContextAccessor HttpContextAccessor
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject MudTheme FshTheme
@inject ITenantThemeState TenantThemeState
@inject IThemeStateFactory ThemeStateFactory
@inject FSH.Playground.Blazor.ApiClient.IIdentityClient IdentityClient
@inject IUserProfileState UserProfileState
@inject IDialogService DialogService
@inject IAuthStateNotifier AuthStateNotifier
@inject IJSRuntime JS

<MudThemeProvider Theme="@_theme" IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

@if (!_authStatusLoaded)
{
    <MudContainer MaxWidth="MaxWidth.False"
                  Class="d-flex justify-center align-center"
                  Style="min-height:100vh;">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </MudContainer>
}
else if (!_isAuthenticated)
{
    <SimpleLogin />
}
else
{
    <MudLayout>
        <MudAppBar Elevation="0">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
            <MudSpacer />
            <MudIconButton Icon="@(DarkLightModeButtonIcon)" Color="Color.Inherit" OnClick="@DarkModeToggle" />
            <FshAccountMenu UserName="@_userName"
                            UserEmail="@_userEmail"
                            UserRole="@_userRole"
                            AvatarUrl="@_avatarUrl"
                            OnProfileClick="NavigateToProfile"
                            OnAuditingClick="NavigateToAuditing"
                            OnLogoutClick="ConfirmAndLogoutAsync" />
        </MudAppBar>
        <MudDrawer id="nav-drawer" @bind-Open="_drawerOpen" Elevation="0">
            <MudDrawerHeader>
                <FshDrawerHeader Title="FSH Playground" />
            </MudDrawerHeader>
            <NavMenu />
        </MudDrawer>
        <MudMainContent Class="pt-20" Style="padding-left:0;padding-right:0;">
            <MudContainer Class="fsh-section page-shell" MaxWidth="MaxWidth.False">
                @Body
            </MudContainer>
        </MudMainContent>
    </MudLayout>
}

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">??</span>
</div>

@code {
    private bool _drawerOpen = true;
    private bool _isDarkMode = false;
    private MudTheme? _theme = null;
    private bool _authStatusLoaded;
    private bool _isAuthenticated;
    private string _userName = "User";
    private string? _userEmail;
    private string? _userRole;
    private string? _avatarUrl;
    private string? _logoUrl;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        // SSR-friendly authentication check via HttpContext
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _isAuthenticated = authState.User?.Identity?.IsAuthenticated ?? false;

        if (_isAuthenticated)
        {
            // Extract user info from claims (available in SSR)
            var user = authState.User!;
            _userName = user.FindFirst(ClaimTypes.Name)?.Value ?? user.FindFirst(ClaimTypes.Email)?.Value ?? "User";
            _userEmail = user.FindFirst(ClaimTypes.Email)?.Value;
            _userRole = user.FindFirst(ClaimTypes.Role)?.Value;

            // Load theme from cache (fast, SSR-compatible)
            var httpContext = HttpContextAccessor.HttpContext;
            if (httpContext is not null)
            {
                var tenantId = httpContext.Request.Cookies["fsh_tenant"] ?? "root";
                var themeSettings = await ThemeStateFactory.GetThemeAsync(tenantId);
                _theme = themeSettings.ToMudTheme();
                TenantThemeState.UpdateSettings(themeSettings);
                _logoUrl = themeSettings.BrandAssets.LogoUrl; // light mode initially
                // Dark mode preference is user-specific, default to false for SSR
                _isDarkMode = false;
            }
        }
        else
        {
            // Use default theme for non-authenticated users
            _theme = TenantThemeState.Theme;
            _isDarkMode = false;
        }

        // Subscribe to theme changes (for Interactive mode)
        TenantThemeState.OnThemeChanged += HandleThemeChanged;

        // Subscribe to profile changes (for syncing across components)
        UserProfileState.OnProfileChanged += HandleProfileChanged;

        // Subscribe to session expiration (for token refresh failures)
        AuthStateNotifier.SessionExpired += HandleSessionExpired;

        // Subscribe to authentication state changes
        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;

        _authStatusLoaded = true;
    }

    private void HandleSessionExpired(object? sender, EventArgs e)
    {
        // Navigate to login with session expired message
        // Use forceLoad to ensure a full page refresh and cookie clearing
        InvokeAsync(() => Navigation.NavigateTo("/login?toast=session_expired", forceLoad: true));
    }

    private void HandleThemeChanged()
    {
        _theme = TenantThemeState.Theme;
        _isDarkMode = TenantThemeState.IsDarkMode;
        _logoUrl = _isDarkMode ? TenantThemeState.Current.BrandAssets.LogoDarkUrl : TenantThemeState.Current.BrandAssets.LogoUrl;
        InvokeAsync(StateHasChanged);
    }

    private void HandleProfileChanged()
    {
        _userName = UserProfileState.UserName;
        _userEmail = UserProfileState.UserEmail;
        _userRole = UserProfileState.UserRole;
        _avatarUrl = UserProfileState.AvatarUrl;
        InvokeAsync(StateHasChanged);
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        var authState = await task;
        var wasAuthenticated = _isAuthenticated;
        _isAuthenticated = authState.User?.Identity?.IsAuthenticated ?? false;

        if (!wasAuthenticated && _isAuthenticated)
        {
            // User just logged in, load theme and user info
            var user = authState.User!;
            _userName = user.FindFirst(ClaimTypes.Name)?.Value ?? user.FindFirst(ClaimTypes.Email)?.Value ?? "User";
            _userEmail = user.FindFirst(ClaimTypes.Email)?.Value;
            _userRole = user.FindFirst(ClaimTypes.Role)?.Value;

            await TenantThemeState.LoadThemeAsync();
            _theme = TenantThemeState.Theme;
            _isDarkMode = TenantThemeState.IsDarkMode;
            _logoUrl = _isDarkMode ? TenantThemeState.Current.BrandAssets.LogoDarkUrl : TenantThemeState.Current.BrandAssets.LogoUrl;

            await InvokeAsync(StateHasChanged);
        }
        else if (wasAuthenticated && !_isAuthenticated)
        {
            // User logged out, reset to default
            await TenantThemeState.ResetThemeAsync();
            _theme = TenantThemeState.Theme;
            _isDarkMode = false;
            _logoUrl = null;
            await ApplyFaviconAsync(); // reset to default
            await InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        TenantThemeState.OnThemeChanged -= HandleThemeChanged;
        UserProfileState.OnProfileChanged -= HandleProfileChanged;
        AuthStateNotifier.SessionExpired -= HandleSessionExpired;
        AuthenticationStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (_isAuthenticated)
        {
            // Apply theme assets (favicon)
            await ApplyFaviconAsync();

            if (firstRender)
            {
                // Load full profile in Interactive mode
                await LoadUserProfileAsync();

                // Handle toast notifications
                var currentUri = new Uri(Navigation.Uri);
                var query = QueryHelpers.ParseQuery(currentUri.Query);
                if (query.TryGetValue("toast", out var toastValues))
                {
                    var toast = toastValues.ToString();
                    if (toast == "login_success")
                    {
                        Snackbar.Add("Signed in.", Severity.Success);
                    }
                    else if (toast == "logout_success")
                    {
                        Snackbar.Add("Signed out.", Severity.Success);
                    }
                    else if (toast == "session_expired")
                    {
                        Snackbar.Add("Your session has expired. Please sign in again.", Severity.Warning);
                    }

                    var cleanUri = currentUri.GetLeftPart(UriPartial.Path);
                    Navigation.NavigateTo(cleanUri, false);
                }

                StateHasChanged();
            }
        }
    }

    private async Task ConfirmAndLogoutAsync()
    {
        var confirmed = await DialogService.ShowSignOutConfirmAsync();
        if (confirmed)
        {
            await LogoutAsync();
        }
    }

    private Task LogoutAsync()
    {
        // Use browser navigation to ensure the cookie is cleared properly
        // The server will clear the auth cookie and redirect to login page
        Navigation.NavigateTo("/auth/logout", forceLoad: true);
        return Task.CompletedTask;
    }

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void DarkModeToggle()
    {
        TenantThemeState.ToggleDarkMode();
    }

    public string DarkLightModeButtonIcon => _isDarkMode switch
    {
        true => Icons.Material.Rounded.AutoMode,
        false => Icons.Material.Outlined.DarkMode,
    };

    private async Task ApplyFaviconAsync()
    {
        try
        {
            var faviconUrl = TenantThemeState.Current.BrandAssets.FaviconUrl;
            await JS.InvokeVoidAsync("FshTheme.setFavicon", faviconUrl);
        }
        catch (Exception ex)
        {
            // Log or ignore if JS not ready
            Console.WriteLine($"Failed to apply favicon: {ex.Message}");
        }
    }

    private async Task LoadUserProfileAsync()
    {
        try
        {
            var profile = await IdentityClient.ProfileGetAsync();
            if (profile is not null)
            {
                _userName = $"{profile.FirstName} {profile.LastName}".Trim();
                if (string.IsNullOrWhiteSpace(_userName))
                {
                    _userName = profile.Email ?? "User";
                }
                _userEmail = profile.Email;
                _avatarUrl = profile.ImageUrl;

                // Update shared profile state so other components can access it
                UserProfileState.UpdateProfile(_userName, _userEmail, _userRole, _avatarUrl);

                StateHasChanged();
            }
        }
        catch
        {
            // Use defaults if profile loading fails
            _userName = "User";
        }
    }

    private void NavigateToProfile()
    {
        Navigation.NavigateTo("/profile");
    }

    private void NavigateToSettings()
    {
        Navigation.NavigateTo("/settings/profile");
    }

    private void NavigateToAuditing()
    {
        Navigation.NavigateTo("/audits");
    }
}
