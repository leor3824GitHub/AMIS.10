@using FSH.Framework.Shared.Constants
@using FSH.Framework.Shared.Multitenancy
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<nav class="fsh-nav">
    <MudNavMenu Class="pa-2" Rounded="true" Margin="Margin.Dense" Color="Color.Primary">
        <!-- Home - Root Item -->
        <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Outlined.Home">
            Home
        </MudNavLink>

        <!-- Administration Section -->
        <div class="fsh-nav-section-title">Administration</div>

        <MudNavLink Href="/users" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.Person">
            Users
        </MudNavLink>
        <MudNavLink Href="/roles" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.AdminPanelSettings">
            Roles
        </MudNavLink>
        <MudNavLink Href="/groups" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.Groups">
            Groups
        </MudNavLink>

        @if (_isRootTenantAdmin)
        {
            <MudNavLink Href="/tenants" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.CorporateFare">
                Tenants
            </MudNavLink>
            <MudNavLink Href="/tenants/settings" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.Tune">
                Tenant Settings
            </MudNavLink>
        }

        <MudNavLink Href="/audits" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.History">
            Audit Logs
        </MudNavLink>

        <!-- Communication Section -->
        <div class="fsh-nav-section-title">Communication</div>

        <MudNavLink Href="/chat" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.Chat">
            Chat
        </MudNavLink>

        <MudNavLink Href="/notifications" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.Notifications">
            Notifications
        </MudNavLink>

        <!-- System Section -->
        <div class="fsh-nav-section-title">System</div>

        <MudNavLink Href="/health" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.MonitorHeart">
            Health
        </MudNavLink>

        <MudNavLink Href="/logs" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.Terminal">
            Logs
        </MudNavLink>

        <!-- Settings Section -->
        <div class="fsh-nav-section-title">Settings</div>

        <MudNavLink Href="/settings/profile" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.ManageAccounts">
            Account
        </MudNavLink>
        <MudNavLink Href="/settings/theme" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.Palette">
            Theme
        </MudNavLink>
        <MudNavLink Href="/settings/security" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.Security">
            Security
        </MudNavLink>
        <MudNavLink Href="/sessions" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.Devices">
            Sessions
        </MudNavLink>

        <MudNavLink Href="/about" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Outlined.Info">
            About
        </MudNavLink>
    </MudNavMenu>
</nav>

@code {
    private bool _isRootTenantAdmin;

    protected override async Task OnInitializedAsync()
    {
        await CheckRootTenantAdmin();
    }

    private async Task CheckRootTenantAdmin()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated != true)
            {
                _isRootTenantAdmin = false;
                return;
            }

            var tenant = user.FindFirst(CustomClaims.Tenant)?.Value;
            var isRootTenant = string.Equals(tenant, MultitenancyConstants.Root.Id, StringComparison.OrdinalIgnoreCase);

            var roles = user.FindAll(System.Security.Claims.ClaimTypes.Role).Select(c => c.Value).ToList();
            var isAdmin = roles.Any(r => string.Equals(r, RoleConstants.Admin, StringComparison.OrdinalIgnoreCase));

            _isRootTenantAdmin = isRootTenant && isAdmin;
        }
        catch
        {
            _isRootTenantAdmin = false;
        }
    }
}
